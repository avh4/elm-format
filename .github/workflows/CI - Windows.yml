name: CI - Windows

on:
  push:
    branches: '*'
  pull_request:
    branches: [ $default-branch ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Configure environment
      run: |
        git config --global core.autocrlf false
        echo "::add-path::C:\Program Files\Git\bin"
        bash -c "echo hi"
    - uses: actions/checkout@v2
    - name: Install jq
      run: |
        mkdir -p ~/jq-install
        cd ~/jq-install
        Invoke-WebRequest -OutFile ~/jq-install/jq.exe https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe
        echo "::add-path::$HOME/jq-install"
    - name: Install stack
      shell: powershell
      run: |
        mkdir -p ~/stack-install
        cd ~/stack-install
        Invoke-WebRequest -OutFile ~/stack-install/stack.zip https://get.haskellstack.org/stable/windows-x86_64.zip
        7z x stack.zip stack.exe
        echo "::add-path::$HOME/stack-install"
    - uses: actions/cache@v1
      with:
        path: ~\AppData\Roaming\stack
        key: ${{ runner.os }}-stack
    - run: stack --version
    - run: stack setup
    - run: stack build --only-dependencies
    - run: stack install shake
    - name: Build
      run: stack runhaskell Shakefile.hs -- build
    - name: Tests
      run: stack runhaskell Shakefile.hs
